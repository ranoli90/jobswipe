name: Mobile CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'mobile-app/**'
      - 'flutter/**'
      - '.github/workflows/mobile-ci-cd.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mobile-app/**'
      - 'flutter/**'
      - '.github/workflows/mobile-ci-cd.yml'

permissions:
  contents: read

jobs:
  test:
    name: Test Mobile App
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile-app

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          mobile-app/.pub-cache
          mobile-app/.flutter-plugins
          mobile-app/.flutter-plugins-dependencies
        key: ${{ runner.os }}-flutter-${{ hashFiles('mobile-app/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Install dependencies
      run: flutter pub get

    - name: Run Flutter analyze
      run: flutter analyze --no-pub

    - name: Run Flutter tests
      run: flutter test --coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: mobile-app/coverage/lcov.info
        flags: mobile
        name: mobile-coverage

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: mobile-app

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          mobile-app/.pub-cache
          mobile-app/.flutter-plugins
          mobile-app/.flutter-plugins-dependencies
        key: ${{ runner.os }}-flutter-${{ hashFiles('mobile-app/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Install dependencies
      run: flutter pub get

    - name: Build Android APK
      run: flutter build apk --release --dart-define=ENV=production

    - name: Build Android App Bundle
      run: flutter build appbundle --release --dart-define=ENV=production

    - name: Upload APK artifact
      uses: actions/upload-artifact@v6
      with:
        name: android-apk
        path: mobile-app/build/app/outputs/flutter-apk/app-release.apk

    - name: Upload App Bundle artifact
      uses: actions/upload-artifact@v6
      with:
        name: android-aab
        path: mobile-app/build/app/outputs/bundle/release/app-release.aab

  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    needs: test
    defaults:
      run:
        working-directory: mobile-app

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          mobile-app/.pub-cache
          mobile-app/.flutter-plugins
          mobile-app/.flutter-plugins-dependencies
        key: ${{ runner.os }}-flutter-${{ hashFiles('mobile-app/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Install dependencies
      run: flutter pub get

    - name: Build iOS IPA
      run: flutter build ios --release --dart-define=ENV=production --no-codesign

    - name: Upload iOS artifact
      uses: actions/upload-artifact@v6
      with:
        name: ios-build
        path: mobile-app/build/ios/iphoneos/

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Download Android artifacts
      uses: actions/download-artifact@v7
      with:
        name: android-apk
        path: ./artifacts/android/

    - name: Download iOS artifacts
      uses: actions/download-artifact@v7
      with:
        name: ios-build
        path: ./artifacts/ios/

    - name: Set up Ruby for Fastlane
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    - name: Install Fastlane
      run: gem install fastlane

    - name: Deploy to TestFlight and Internal Testing
      working-directory: mobile-app
      run: |
        # Note: Configure fastlane with proper credentials in secrets
        # This would deploy to TestFlight for iOS and Internal testing for Android
        echo "Staging deployment would happen here with fastlane"
      env:
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_ITC_TEAM_ID: ${{ secrets.FASTLANE_ITC_TEAM_ID }}
        FASTLANE_USER: ${{ secrets.FASTLANE_USER }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Download Android artifacts
      uses: actions/download-artifact@v7
      with:
        name: android-apk
        path: ./artifacts/android/

    - name: Download iOS artifacts
      uses: actions/download-artifact@v7
      with:
        name: ios-build
        path: ./artifacts/ios/

    - name: Set up Ruby for Fastlane
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    - name: Install Fastlane
      run: gem install fastlane

    - name: Deploy to App Stores
      working-directory: mobile-app
      run: |
        # Production deployment to Google Play Store and Apple App Store
        # Requires proper fastlane configuration and store credentials
        echo "Production deployment would happen here with fastlane"
      env:
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_ITC_TEAM_ID: ${{ secrets.FASTLANE_ITC_TEAM_ID }}
        FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
        SUPPLY_JSON_KEY_DATA: ${{ secrets.SUPPLY_JSON_KEY_DATA }}
        SUPPLY_PACKAGE_NAME: ${{ secrets.SUPPLY_PACKAGE_NAME }}