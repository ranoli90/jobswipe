# JobSwipe Prometheus Alerting Rules
# Cost-free observability with free alerting

groups:
  - name: jobswipe-alerts
    rules:
      # High Error Rate - Critical
      - alert: HighErrorRate
        expr: rate(api_requests_total{status_code=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "More than 5% of API requests are returning 5xx errors"
      
      # High Latency - Warning
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(api_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API latency above 2 seconds"
          description: "p95 latency exceeds 2 seconds"
      
      # Ollama Down - Critical
      - alert: OllamaDown
        expr: up{job="ollama"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Ollama service is down"
          description: "Local LLM service is not responding"
      
      # High Memory Usage - Warning
      - alert: HighMemoryUsage
        expr: container_memory_usage_bytes{container="backend"} > 1073741824  # 1GB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Backend container memory usage high"
          description: "Memory usage exceeds 1GB"
      
      # Database Connection Issues - Critical
      - alert: DatabaseConnectionIssues
        expr: pg_stat_activity_count > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High database connection count"
          description: "PostgreSQL has more than 100 active connections"
      
      # Redis Memory High - Warning
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes > 536870912  # 512MB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis memory usage high"
          description: "Redis memory usage exceeds 512MB"
      
      # Job Ingestion Failures - Warning
      - alert: JobIngestionFailures
        expr: rate(job_ingestion_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Job ingestion errors detected"
          description: "More than 10% of job ingestion requests are failing"
      
      # Application Automation Failures - Warning
      - alert: ApplicationAutomationFailures
        expr: rate(application_task_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Application automation errors detected"
          description: "More than 10% of application automation tasks are failing"
      
      # Low Cache Hit Rate - Warning
      - alert: LowCacheHitRate
        expr: embedding_cache_hits / (embedding_cache_hits + embedding_cache_misses) < 0.5
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Embedding cache hit rate below 50%"
          description: "Cache efficiency is low, consider increasing cache size"
      
      # Rate Limit Hit - Info
      - alert: RateLimitHit
        expr: increase(api_rate_limit_hits_total[5m]) > 10
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "Rate limits being hit frequently"
          description: "More than 10 rate limit hits in the last 5 minutes"
