# Database Migration Guide

This guide explains how to use Alembic for database migrations in the JobSwipe backend.

## Overview

The application now uses Alembic for proper database schema management instead of manual ALTER scripts. This ensures:

- **Version-controlled schema changes**
- **Safe rollbacks in production**
- **Data integrity during deployments**
- **Automated migration testing**

## Quick Start

### 1. Initialize Database

The database is automatically initialized with migrations when the application starts. No manual intervention required.

### 2. Create a New Migration

When you modify the SQLAlchemy models in `backend/db/models.py`, create a migration:

```bash
cd backend

# Create migration with autogenerated changes
python create_migration.py "add user preferences table"

# Or create with data migration template
python create_migration.py "migrate user settings" --data-migration
```

### 3. Review and Edit Migration

Alembic will generate a migration file in `backend/alembic/versions/`. Review it and make any necessary adjustments.

### 4. Test Migration

```bash
# Run migration tests
python test_migrations.py

# Or validate migrations for deployment
python validate_migrations.py
```

### 5. Apply Migration

Migrations are automatically applied when the application starts. For manual application:

```bash
cd backend
alembic upgrade head
```

## Migration Commands

### Basic Commands

```bash
# Check current migration status
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic heads

# Apply all pending migrations
alembic upgrade head

# Rollback to specific revision
alembic downgrade <revision_id>

# Rollback all migrations
alembic downgrade base
```

### Advanced Commands

```bash
# Create new migration (autogenerated)
alembic revision --autogenerate -m "migration message"

# Create empty migration
alembic revision -m "migration message"

# Show SQL that would be executed (dry run)
alembic upgrade head --sql

# Merge multiple heads
alembic merge <revision_id_1> <revision_id_2>
```

## Data Migrations

For schema changes that require data transformation:

1. Create migration with data migration template:
   ```bash
   python create_migration.py "migrate user data" --data-migration
   ```

2. Edit the generated migration file to add data transformation logic in the `upgrade()` function.

3. Example data migration:
   ```python
   def upgrade():
       # Schema changes first
       op.add_column('users', sa.Column('preferences', sa.JSON(), nullable=True))

       # Data migration
       connection = op.get_bind()
       connection.execute(
           sa.text("""
               UPDATE users
               SET preferences = '{"theme": "light"}'::jsonb
               WHERE preferences IS NULL
           """)
       )
   ```

## Testing Migrations

### Automated Testing

Run the comprehensive migration test suite:

```bash
cd backend
python test_migrations.py
```

This tests:
- Forward migration
- Rollback migration
- Data integrity
- Performance benchmarks

### Pre-deployment Validation

Before deploying to production:

```bash
cd backend
python validate_migrations.py
```

This validates:
- Alembic setup
- Migration file syntax
- Environment configuration
- Database connectivity

## Rollback Procedures

### Emergency Rollback

If a migration causes issues in production:

1. **Immediate rollback** (last migration only):
   ```bash
   alembic downgrade -1
   ```

2. **Full rollback** (to specific version):
   ```bash
   alembic downgrade <safe_revision_id>
   ```

3. **Complete reset** (dangerous - use only if necessary):
   ```bash
   alembic downgrade base
   ```

### Rollback Best Practices

- Always test rollbacks in staging first
- Have a backup strategy before deploying migrations
- Document rollback procedures for each migration
- Use transaction-safe operations in migrations

## Production Deployment

### Deployment Checklist

- [ ] Run `python validate_migrations.py` in CI/CD
- [ ] Backup database before deployment
- [ ] Deploy application (migrations run automatically)
- [ ] Monitor application logs for migration errors
- [ ] Verify data integrity post-deployment
- [ ] Test rollback procedures in staging

### Environment Variables

Ensure these are set in production:

```bash
DATABASE_URL=postgresql://user:password@host:port/database
ENVIRONMENT=production
```

### Monitoring

Monitor these during deployment:

- Migration execution time
- Database connection pool usage
- Application startup logs
- Error rates post-deployment

## Troubleshooting

### Common Issues

1. **Migration fails with "relation does not exist"**
   - Check migration dependencies
   - Ensure migrations are applied in order

2. **Data loss during migration**
   - Always backup before migration
   - Test data migrations thoroughly

3. **Migration stuck/timeout**
   - Check database locks
   - Increase timeout settings if needed

4. **Alembic version table missing**
   - Run `alembic stamp head` to initialize

### Recovery Commands

```bash
# Force migration state (use carefully)
alembic stamp <revision_id>

# Skip problematic migration
alembic upgrade <revision_id>+1

# Reset migration state
alembic downgrade base
alembic upgrade head
```

## Migration File Structure

```
backend/
├── alembic/
│   ├── env.py              # Migration environment
│   ├── alembic.ini         # Alembic configuration
│   └── versions/           # Migration files
│       └── 001_initial.py  # Initial migration
├── db/
│   ├── database.py         # Database connection
│   └── models.py           # SQLAlchemy models
├── create_migration.py     # Migration creation helper
├── test_migrations.py      # Migration testing
└── validate_migrations.py  # Pre-deployment validation
```

## Best Practices

### Migration Writing

- Keep migrations small and focused
- Test migrations on copy of production data
- Include both upgrade and downgrade paths
- Document any manual steps required
- Use transactions for data migrations

### Schema Design

- Plan schema changes carefully
- Consider backward compatibility
- Use proper constraints and indexes
- Document column purposes

### Deployment

- Use blue-green deployments for major changes
- Have rollback plan for every migration
- Monitor performance impact of migrations
- Communicate with stakeholders about downtime

## Support

For migration issues:

1. Check the logs in `alembic.log`
2. Review the migration file syntax
3. Test on development database first
4. Consult the Alembic documentation

## Migration Examples

See the existing migrations in `backend/alembic/versions/` for examples of:

- Table creation
- Column addition/modification
- Index creation
- Data migrations
- Proper rollback procedures</content>
</xai:function_call">The search_replace operation was successful. The file backend/MIGRATION_README.md has been updated with the new content.